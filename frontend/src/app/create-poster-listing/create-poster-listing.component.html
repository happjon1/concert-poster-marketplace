<div class="max-w-4xl mx-auto p-4 md:p-6">
  <mat-card class="shadow-md">
    <mat-card-header class="mb-4">
      <mat-card-title class="text-2xl font-medium mb-4"
        >Create New Poster Listing</mat-card-title
      >
    </mat-card-header>

    <mat-card-content>
      @if (error()) {
        <mat-error class="mb-4">{{ error() }}</mat-error>
      }

      <form
        [formGroup]="posterForm"
        (ngSubmit)="onSubmit()"
        class="flex flex-col gap-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Title -->
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Title</mat-label>
            <input matInput formControlName="title" required />
            <mat-error
              *ngIf="
                posterForm.get('title')?.invalid &&
                posterForm.get('title')?.touched
              ">
              Title is required
            </mat-error>
          </mat-form-field>

          <!-- Artist/Band -->
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Artist/Band</mat-label>
            <input matInput formControlName="artist" required />
            <mat-error
              *ngIf="
                posterForm.get('artist')?.invalid &&
                posterForm.get('artist')?.touched
              ">
              Artist is required
            </mat-error>
          </mat-form-field>

          <!-- Venue -->
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Venue</mat-label>
            <input matInput formControlName="venue" required />
            <mat-error
              *ngIf="
                posterForm.get('venue')?.invalid &&
                posterForm.get('venue')?.touched
              ">
              Venue is required
            </mat-error>
          </mat-form-field>

          <!-- Event Date -->
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Event Date</mat-label>
            <input
              matInput
              [matDatepicker]="picker"
              formControlName="eventDate"
              required />
            <mat-datepicker-toggle
              matIconSuffix
              [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error
              *ngIf="
                posterForm.get('eventDate')?.invalid &&
                posterForm.get('eventDate')?.touched
              ">
              Valid date is required
            </mat-error>
          </mat-form-field>

          <!-- Dimensions -->
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Dimensions</mat-label>
            <input
              matInput
              formControlName="dimensions"
              placeholder="e.g. 18 x 24 inches"
              required />
            <mat-error
              *ngIf="
                posterForm.get('dimensions')?.invalid &&
                posterForm.get('dimensions')?.touched
              ">
              Dimensions are required
            </mat-error>
          </mat-form-field>

          <!-- Condition -->
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Condition</mat-label>
            <mat-select formControlName="condition" required>
              <mat-option value="Mint">Mint</mat-option>
              <mat-option value="Near Mint">Near Mint</mat-option>
              <mat-option value="Excellent">Excellent</mat-option>
              <mat-option value="Very Good">Very Good</mat-option>
              <mat-option value="Good">Good</mat-option>
              <mat-option value="Fair">Fair</mat-option>
              <mat-option value="Poor">Poor</mat-option>
            </mat-select>
            <mat-error
              *ngIf="
                posterForm.get('condition')?.invalid &&
                posterForm.get('condition')?.touched
              ">
              Condition is required
            </mat-error>
          </mat-form-field>

          <!-- Price -->
          <mat-form-field appearance="fill" class="w-full">
            <mat-label>Price ($)</mat-label>
            <span matPrefix>$&nbsp;</span>
            <input
              matInput
              type="number"
              formControlName="price"
              min="0.01"
              step="0.01"
              required />
            <mat-error
              *ngIf="
                posterForm.get('price')?.invalid &&
                posterForm.get('price')?.touched
              ">
              <span *ngIf="posterForm.get('price')?.errors?.['required']"
                >Price is required</span
              >
              <span *ngIf="posterForm.get('price')?.errors?.['min']"
                >Price must be greater than 0</span
              >
            </mat-error>
          </mat-form-field>

          <!-- Description - Full width -->
          <mat-form-field appearance="fill" class="w-full md:col-span-2">
            <mat-label>Description</mat-label>
            <textarea
              matInput
              formControlName="description"
              rows="5"
              required></textarea>
            <mat-error
              *ngIf="
                posterForm.get('description')?.invalid &&
                posterForm.get('description')?.touched
              ">
              Description is required
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Image Upload Section -->
        <div class="w-full mt-2 bg-gray-50 p-4 rounded-md">
          <p class="text-base font-medium mb-2">Images*</p>

          <div class="flex flex-wrap items-center gap-4 mb-4">
            <button
              type="button"
              mat-flat-button
              color="primary"
              (click)="fileInput.click()"
              [disabled]="loading()">
              <mat-icon class="mr-2">add_photo_alternate</mat-icon>
              Upload Images
            </button>
            <input
              hidden
              type="file"
              accept="image/*"
              multiple
              #fileInput
              (change)="onFileSelected($event)"
              [disabled]="loading()" />

            <p class="text-sm text-gray-500">
              Upload up to 5 images. First image will be the thumbnail.
            </p>
          </div>

          @if (fileErrors()) {
            <mat-error class="mb-4">{{ fileErrors() }}</mat-error>
          }

          <!-- Image Previews -->
          @if (imagePreviewUrls.length > 0) {
            <div
              class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mt-4">
              @for (url of imagePreviewUrls; track $index) {
                <div
                  class="relative group rounded-md overflow-hidden shadow-sm border border-gray-200">
                  <img
                    [src]="url"
                    class="w-full h-32 object-cover"
                    alt="Preview" />
                  <button
                    type="button"
                    mat-mini-fab
                    color="warn"
                    class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity"
                    (click)="removeImage($index)">
                    <mat-icon>close</mat-icon>
                  </button>
                </div>
              }
            </div>
          } @else {
            <div
              class="border-2 border-dashed border-gray-300 rounded-md p-8 text-center bg-white">
              <mat-icon class="text-gray-400 text-4xl mb-2">image</mat-icon>
              <p class="text-gray-500">No images selected yet</p>
            </div>
          }
        </div>
      </form>
    </mat-card-content>

    <mat-card-actions
      class="flex justify-end gap-4 p-4 border-t border-gray-200 mt-4">
      <button mat-stroked-button routerLink="/posters">Cancel</button>
      <button
        mat-raised-button
        color="primary"
        (click)="onSubmit()"
        [disabled]="
          posterForm.invalid || loading() || imagePreviewUrls.length === 0
        ">
        @if (loading()) {
          <mat-spinner diameter="24" class="mr-2"></mat-spinner> Creating...
        } @else {
          Create Listing
        }
      </button>
    </mat-card-actions>
  </mat-card>
</div>
