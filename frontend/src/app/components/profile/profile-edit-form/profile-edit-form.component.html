<!-- Edit Mode with Multiple Sections -->
<form [formGroup]="profileForm" (ngSubmit)="onSaveProfile()">
  <h2 class="fs-5 fw-medium mb-4">Edit Profile</h2>

  <!-- Section Navigation -->
  <div class="nav nav-tabs mb-4">
    <button
      type="button"
      class="nav-link"
      [class.active]="activeSection === 'basic'"
      (click)="switchSection('basic')">
      <i class="bi bi-person me-2"></i>Basic Details
    </button>
    <button
      type="button"
      class="nav-link"
      [class.active]="activeSection === 'addresses'"
      (click)="switchSection('addresses')">
      <i class="bi bi-geo-alt me-2"></i>Addresses
    </button>
    <button
      type="button"
      class="nav-link"
      [class.active]="activeSection === 'wallet'"
      (click)="switchSection('wallet')">
      <i class="bi bi-wallet2 me-2"></i>Payment Info
    </button>
  </div>

  <!-- Basic Details Section -->
  <div class="section-content" [hidden]="activeSection !== 'basic'">
    <div class="mb-4">
      <div class="form-floating">
        <input
          type="text"
          id="name"
          class="form-control"
          formControlName="name"
          placeholder="Full name"
          [ngClass]="{
            'is-invalid':
              profileForm.get('name')?.invalid &&
              profileForm.get('name')?.touched,
          }" />
        <label for="name"> <i class="bi bi-person me-2"></i>Name </label>
        <div
          class="invalid-feedback"
          *ngIf="
            profileForm.get('name')?.invalid && profileForm.get('name')?.touched
          ">
          Name is required (min. 2 characters)
        </div>
      </div>
    </div>

    <div class="mb-4">
      <div class="form-floating">
        <input
          type="email"
          id="email"
          class="form-control"
          formControlName="email"
          placeholder="Email address"
          [ngClass]="{
            'is-invalid':
              profileForm.get('email')?.invalid &&
              profileForm.get('email')?.touched,
          }" />
        <label for="email"> <i class="bi bi-envelope me-2"></i>Email </label>
        <div
          class="invalid-feedback"
          *ngIf="
            profileForm.get('email')?.invalid &&
            profileForm.get('email')?.touched
          ">
          Valid email is required
        </div>
      </div>
    </div>

    <div class="mb-4">
      <div class="form-floating">
        <textarea
          id="bio"
          class="form-control"
          formControlName="bio"
          placeholder="Tell us about yourself"
          style="height: 120px">
        </textarea>
        <label for="bio"> <i class="bi bi-card-text me-2"></i>Bio </label>
        <div class="form-text text-end">
          {{ profileForm.get('bio')?.value?.length || 0 }}/300
        </div>
      </div>
    </div>
  </div>

  <!-- Addresses Section -->
  <div class="section-content" [hidden]="activeSection !== 'addresses'">
    <div *ngIf="addressError" class="alert alert-danger mb-3">
      {{ addressError }}
    </div>

    <div formArrayName="addresses">
      <div
        *ngFor="let addressGroup of addressesFormArray.controls; let i = index">
        <div class="card mb-3" [formGroupName]="i">
          <div
            class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title fs-6 mb-0">
              Address {{ i + 1 }}
              <span
                *ngIf="addressGroup.get('isDefault')?.value"
                class="badge bg-primary ms-2"
                >Default</span
              >
            </h5>
            <div>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger"
                (click)="removeAddressGroup(i)"
                *ngIf="addressesFormArray.length > 1">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>

          <div class="card-body">
            <div class="mb-3">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="label-{{ i }}"
                  formControlName="label"
                  placeholder="Address Label (e.g. Home, Work)" />
                <label for="label-{{ i }}"
                  ><i class="bi bi-tag me-2"></i>Label (optional)</label
                >
              </div>
            </div>

            <div class="row g-3">
              <div class="col-12">
                <div class="form-floating">
                  <input
                    type="text"
                    class="form-control"
                    id="address1-{{ i }}"
                    formControlName="address1"
                    placeholder="Street Address"
                    [ngClass]="{
                      'is-invalid':
                        addressGroup.get('address1')?.invalid &&
                        addressGroup.get('address1')?.touched,
                    }" />
                  <label for="address1-{{ i }}"
                    ><i class="bi bi-signpost me-2"></i>Street Address</label
                  >
                  <div
                    class="invalid-feedback"
                    *ngIf="
                      addressGroup.get('address1')?.invalid &&
                      addressGroup.get('address1')?.touched
                    ">
                    Street address is required
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="form-floating">
                  <input
                    type="text"
                    class="form-control"
                    id="address2-{{ i }}"
                    formControlName="address2"
                    placeholder="Apartment, suite, etc." />
                  <label for="address2-{{ i }}"
                    >Apartment, suite, etc. (optional)</label
                  >
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-floating">
                  <input
                    type="text"
                    class="form-control"
                    id="city-{{ i }}"
                    formControlName="city"
                    placeholder="City"
                    [ngClass]="{
                      'is-invalid':
                        addressGroup.get('city')?.invalid &&
                        addressGroup.get('city')?.touched,
                    }" />
                  <label for="city-{{ i }}"
                    ><i class="bi bi-building me-2"></i>City</label
                  >
                  <div
                    class="invalid-feedback"
                    *ngIf="
                      addressGroup.get('city')?.invalid &&
                      addressGroup.get('city')?.touched
                    ">
                    City is required
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-floating">
                  <input
                    type="text"
                    class="form-control"
                    id="state-{{ i }}"
                    formControlName="state"
                    placeholder="State" />
                  <label for="state-{{ i }}">State/Province</label>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-floating">
                  <input
                    type="text"
                    class="form-control"
                    id="zip-{{ i }}"
                    formControlName="zip"
                    placeholder="Zip Code" />
                  <label for="zip-{{ i }}">Zip/Postal Code</label>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-floating">
                  <input
                    type="text"
                    class="form-control"
                    id="country-{{ i }}"
                    formControlName="country"
                    placeholder="Country"
                    [ngClass]="{
                      'is-invalid':
                        addressGroup.get('country')?.invalid &&
                        addressGroup.get('country')?.touched,
                    }" />
                  <label for="country-{{ i }}"
                    ><i class="bi bi-globe me-2"></i>Country</label
                  >
                  <div
                    class="invalid-feedback"
                    *ngIf="
                      addressGroup.get('country')?.invalid &&
                      addressGroup.get('country')?.touched
                    ">
                    Country is required
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="isDefault-{{ i }}"
                    formControlName="isDefault"
                    [disabled]="addressesFormArray.length === 1" />
                  <label class="form-check-label" for="isDefault-{{ i }}">
                    Use as default address
                    <span
                      *ngIf="addressesFormArray.length === 1"
                      class="text-muted small">
                      (automatically set as default)
                    </span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <button
        type="button"
        class="btn btn-outline-secondary w-100 mb-3"
        (click)="addAddressGroup()">
        <i class="bi bi-plus-circle me-2"></i>Add Another Address
      </button>
    </div>
  </div>

  <!-- Wallet Section -->
  <div class="section-content" [hidden]="activeSection !== 'wallet'">
    <div formGroupName="wallet">
      <p class="text-muted mb-4">
        Add your payment information for receiving payments from poster sales.
      </p>

      <div class="mb-4">
        <div class="form-floating">
          <input
            type="email"
            id="paypalEmail"
            class="form-control"
            formControlName="paypalEmail"
            placeholder="PayPal Email"
            [ngClass]="{
              'is-invalid':
                profileForm.get('wallet.paypalEmail')?.invalid &&
                profileForm.get('wallet.paypalEmail')?.touched,
            }" />
          <label for="paypalEmail">
            <i class="bi bi-paypal me-2"></i>PayPal Email
          </label>
          <div
            class="invalid-feedback"
            *ngIf="
              profileForm.get('wallet.paypalEmail')?.invalid &&
              profileForm.get('wallet.paypalEmail')?.touched
            ">
            Please enter a valid email address for PayPal
          </div>
        </div>
      </div>

      <div class="mb-4">
        <div class="form-floating">
          <input
            type="text"
            id="venmoUsername"
            class="form-control"
            formControlName="venmoUsername"
            placeholder="Venmo Username" />
          <label for="venmoUsername">
            <i class="bi bi-credit-card me-2"></i>Venmo Username
          </label>
        </div>
      </div>

      <div class="mb-4">
        <label class="form-label" for="preferredPaymentMethod"
          >Preferred Payment Method</label
        >
        <div class="form-check">
          <input
            class="form-check-input"
            type="radio"
            id="preferPaypal"
            value="paypal"
            formControlName="preferredPaymentMethod" />
          <label class="form-check-label" for="preferPaypal"> PayPal </label>
        </div>
        <div class="form-check">
          <input
            class="form-check-input"
            type="radio"
            id="preferVenmo"
            value="venmo"
            formControlName="preferredPaymentMethod" />
          <label class="form-check-label" for="preferVenmo"> Venmo </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Action Buttons (Always Visible) -->
  <div class="d-flex justify-content-between mt-4">
    <div>
      <!-- Previous/Next Section Navigation -->
      @if (activeSection !== 'basic') {
        <button
          type="button"
          class="btn btn-outline-secondary me-2"
          (click)="
            activeSection === 'addresses'
              ? switchSection('basic')
              : switchSection('addresses')
          ">
          <i class="bi bi-arrow-left me-2"></i>Previous
        </button>
      }

      @if (activeSection !== 'wallet') {
        <button
          type="button"
          class="btn btn-outline-primary"
          (click)="
            activeSection === 'basic'
              ? switchSection('addresses')
              : switchSection('wallet')
          ">
          Next<i class="bi bi-arrow-right ms-2"></i>
        </button>
      }
    </div>

    <div>
      <button
        type="button"
        class="btn btn-outline-danger me-2"
        (click)="onCancelEdit()"
        [disabled]="saving">
        Cancel
      </button>

      <button
        type="submit"
        class="btn btn-primary"
        [disabled]="profileForm.invalid || saving">
        @if (saving) {
          <span
            class="spinner-border spinner-border-sm me-2"
            role="status"></span>
          Saving...
        } @else {
          Save Changes
        }
      </button>
    </div>
  </div>
</form>
